<script>
    var map: L.Map, positionInterval = null
    window.positionInterval = positionInterval
    var currentPopup: L.Popup | null = null

    var agencyIds: {Id: string, Name: string}[] = []
    var agencies: Record<string, AgencyObj | undefined> = {}
    var allPins: unknown[] = []
    window.allPins = allPins
    var userPin: L.Marker | null = null
    var userLocation: {lat: number, lng: number} | null = null
    // var lines = []
    // var patterns = []

    type StopCall = {
        StopPointName: string
        StopPointRef: string
        ExpectedArrivalTime: string
        AimedArrivalTime: string
    }

    type VehicleData = {
        agency: string
        aId: string
        LineRef: string
        PublishedLineName?: string
        LineName?: string
        DirectionRef?: string
        OriginName?: string
        DestinationName?: string
        InCongestion?: boolean
        Occupancy?: string
        OperatorRef?: string
        infoboxOpen?: boolean
        VehicleRef: string
        VehicleLocation: { Latitude: number, Longitude: number }
        MonitoredCall?: StopCall
        OnwardCalls?: { OnwardCall: StopCall[] }
    }

    type VehicleMarker = L.Marker & { metadata: VehicleData }

    type AgencyObj = {
        id: string
        name: string
        vehicles: {
            data: { MonitoredVehicleJourney: VehicleData }[]
            pins: Record<string, VehicleMarker | undefined>
        }
    }

    type TimingPoint = { Name: string }

    type JourneyPattern = {
        DirectionRef: string
        PointsInSequence?: { TimingPointInJourneyPattern: TimingPoint[] }
    }

    var colors = ['#0000FF','#FFA500','#6A4A3A','#800080','#800000','#40E0D0','#FF00FF','#000035','#FF6347','#FA8072','#808000','#7F00FF','#73BF00','#CD7F32','#8A2BE2','#3CB371','#2E8B57','#D2691E','#4682B4','#FF4500','#8B008B','#556B2F', '#8B4513', '#00CED1', '#483D8B', '#8B0000', '#9932CC', '#556B2F', '#2E8B57', '#6B8E23', '#9932CC', '#FF6347', '#20B2AA']
    var customColors: Record<string, Record<string, string>> = {
        SF: {
            E: 'beige',
            F: 'pink',
            J: 'orange',
            K: 'lightblue',
            L: 'purple',
            M: 'green',
            N: 'blue',
            S: 'yellow',
            T: 'red',
            C: 'brown',
            CA: 'brown',
            PM: 'brown',
            PH: 'brown',
        }
    }

    var directionsElement = document.querySelector('#hiddenDirections')
    window.directionsElement = directionsElement
    var directionsManager = false
    window.directionsManager = directionsManager

    // Calculate distance between two locations in miles using Haversine formula
    function calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number) {
        var R = 3958.8 // Earth's radius in miles
        var dLat = (lat2 - lat1) * Math.PI / 180
        var dLon = (lon2 - lon1) * Math.PI / 180
        var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2)
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
        return R * c
    }

    // Show nearby vehicles when user clicks their location pin
    function showNearbyVehicles() {
        if (!userLocation) return

        var loc = userLocation
        var nearbyVehicles: {distance: number, agency: string, route: string, lineName: string, destination: string, vehicleRef: string}[] = []
        var maxDistance = 1.5 // 1.5 mile radius

        // Search through all agencies and their vehicles
        agencyIds.forEach(agency => {
            var aObj = agencies[agency.Id] as AgencyObj | undefined
            if (!aObj || !aObj.vehicles || !aObj.vehicles.data) return

            var aName = aObj.name
            aObj.vehicles.data.forEach(vehicle => {
                var vehicleActivity = vehicle.MonitoredVehicleJourney
                if (!vehicleActivity || !vehicleActivity.VehicleLocation) return

                var vehicleLoc = vehicleActivity.VehicleLocation
                var distance = calculateDistance(
                    loc.lat,
                    loc.lng,
                    vehicleLoc.Latitude,
                    vehicleLoc.Longitude
                )

                if (distance <= maxDistance) {
                    nearbyVehicles.push({
                        distance: distance,
                        agency: aName,
                        route: vehicleActivity.LineRef,
                        lineName: vehicleActivity.PublishedLineName || vehicleActivity.LineRef,
                        destination: vehicleActivity.DestinationName || 'Unknown',
                        vehicleRef: vehicleActivity.VehicleRef
                    })
                }
            })
        })

        // Sort by distance
        nearbyVehicles.sort((a, b) => {
            return a.distance - b.distance
        })

        // Build HTML content
        var content = '<span class="title">Nearby Vehicles</span>'
        content += '<span>Within 1.5 miles of your location</span><br>'

        if (nearbyVehicles.length === 0) {
            content += '<span>No vehicles nearby</span>'
        } else {
            content += '<ol class="stops">'
            nearbyVehicles.forEach(v => {
                content += '<li class="stop">'
                content += '<strong>' + v.route + '</strong> - ' + v.lineName + '<br>'
                content += 'To: ' + v.destination + '<br>'
                content += 'Distance: ' + v.distance.toFixed(2) + ' mi'
                content += '</li>'
            })
            content += '</ol>'
        }

        if (currentPopup) {
            currentPopup.remove()
        }
        currentPopup = window.L.popup()
            .setLatLng([userLocation.lat, userLocation.lng])
            .setContent(content)
            .openOn(map)
    }


    function onMapLoad() {
        window.makeRequest('gtfsoperators', [], unknownRes => {
            var res = unknownRes as {Id: string, Name: string}[]
            res.forEach((agency, i: number) => {
                var cI = i
                if (cI >= colors.length) cI = cI - colors.length
                var color = colors[cI]

                agencyIds.push(agency)

                window.makeRequest('VehicleMonitoring', [['agency', agency.Id]], vehicleResult => {
                    var vehicleData: {MonitoredVehicleJourney: VehicleData}[] = (vehicleResult as any)?.Siri?.ServiceDelivery?.VehicleMonitoringDelivery?.VehicleActivity ?? []

                    var aName = agency.Name
                    switch (aName) {
                        case 'VTA': {
                            aName = 'Valley Transportation Authority (VTA)'
                            break
                        }
                        case 'AC TRANSIT': {
                            aName = 'AC Transit'
                            break
                        }
                    }

                    var aObj = agencies[agency.Id]
                    if (!aObj) {
                        aObj = {
                            id: agency.Id,
                            name: aName,
                            vehicles: {
                                data: vehicleData,
                                pins: {},
                            },
                        }
                    }
                    else {
                        aObj.vehicles.data = vehicleData
                    }

                    var goodPins: { name: string, content: VehicleMarker }[] = []

                    vehicleData.forEach(vehicle => {
                        var vehicleRef = vehicle.MonitoredVehicleJourney.VehicleRef
                        var existingPin = aObj!.vehicles.pins[vehicleRef]
                        if (existingPin) {
                            goodPins.push({
                                name: vehicleRef,
                                content: existingPin
                            })
                        }
                    })
                    aObj.vehicles.pins = {}
                    goodPins.forEach(pin => {
                        aObj!.vehicles.pins[pin.name] = pin.content
                    })

                    vehicleData.forEach((vehicle, _vI: number) => {
                        var vehicleActivity = vehicle.MonitoredVehicleJourney
                        vehicleActivity.agency = aName
                        vehicleActivity.aId = agency.Id
                        var vehicleRef = vehicleActivity.VehicleRef
                        var vehicleLocation = vehicleActivity.VehicleLocation
                        var vehicleLatLng: [number, number] = [vehicleLocation.Latitude, vehicleLocation.Longitude]

                        switch (vehicleActivity.OperatorRef) {
                            case 'SF':
                                var publishedLineName = vehicleActivity.PublishedLineName
                                if (publishedLineName) {
                                    var parts: string[]
                                    if (publishedLineName.includes(' ')) parts = publishedLineName.split(' ')
                                    else parts = [publishedLineName]

                                    parts.forEach((p, i: number) => {
                                        parts[i] = `${p[0]}${p.substring(1).toLowerCase()}`
                                    })

                                    vehicleActivity.PublishedLineName = parts.join(' ')
                                }
                        }

                        var route = vehicleActivity.LineRef
                        if (route) {

                            var width = 30
                            if (route.length > 3) {
                                var exces = route.length-3
                                for (let i3 = 0; i3 < exces; i3++) {
                                    width += 5
                                }
                            }

                            // Check for custom colors based on operator and route
                            var markerColor = color
                            var operatorRef = vehicleActivity.OperatorRef

                            // VTA light rail: use lowercase line name without " Line"
                            if (operatorRef === 'VTA' && vehicleActivity.PublishedLineName && vehicleActivity.PublishedLineName.includes(' Line')) {
                                var lineName = vehicleActivity.PublishedLineName
                                markerColor = lineName.replace(' Line', '').toLowerCase()
                            }
                            // Caltrain: color based on train number
                            else if (operatorRef === 'CT' && route) {
                                var firstDigit = route.charAt(0)
                                if (firstDigit === '8') {
                                    markerColor = 'tan'
                                } else if (firstDigit === '5') {
                                    markerColor = 'red'
                                } else if (firstDigit === '4') {
                                    markerColor = 'aqua'
                                } else if (firstDigit === '1') {
                                    markerColor = 'lightcoral'
                                } else {
                                    markerColor = 'gray'
                                }
                            }
                            // Other custom colors (like SF Muni)
                            else if (operatorRef && customColors[operatorRef] && customColors[operatorRef][route]) {
                                markerColor = customColors[operatorRef][route]
                            }

                            // Add the marker to the map
                            var pin = aObj!.vehicles.pins[vehicleRef]
                            if (pin) {
                                pin.setLatLng(vehicleLatLng);
                            }
                            else {
                                // Create custom DivIcon for vehicle marker
                                var icon = window.L.divIcon({
                                    html: `<div style="background-color: ${markerColor}; color: white; padding: 2px 5px; border-radius: 3px; font-size: 11px; font-weight: bold; text-align: center; white-space: nowrap;">${route}</div>`,
                                    className: 'vehicle-marker',
                                    iconSize: [width, 20],
                                    iconAnchor: [width/2, 10]
                                });

                                vehicleActivity.infoboxOpen = false
                                var newPin = window.L.marker(vehicleLatLng, { icon: icon }) as VehicleMarker;
                                newPin.metadata = vehicleActivity;

                                newPin.on('click', e => {
                                    showVehicleInfo(e, newPin);
                                });

                                newPin.addTo(map);
                                pin = newPin;
                            }
                            aObj!.vehicles.pins[vehicleRef] = pin
                        }
                    })

                    agencies[agency.Id] = aObj
                })

                // windodw.makeRequest('lines', [['operator_id', agency.Id]], lS => {
                //     lines[agency.Id] = lS
                //     patterns[agency.Id] = {}
                //     lS.forEach((line, lI: number) => {
                //         window.makeRequest('patterns', [['operator_id', agency.Id], ['line_id', line.Id]], pattern => {
                //             patterns[agency.Id][line.Id] = pattern
                //         })
                //     })
                // })
            })
        })
    }

    GetMap()
    function GetMap() {
        if (document.getElementById('myMap') && typeof window.L !== 'undefined') {
            // Default location (Bay Area)
            var defaultLocation: [number, number] = [37.7749, -122.4194];
            var initialZoom = 10;

            // Request user's location first
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        // Got user location, use it
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Initialize map with user's location
                        initializeMap([userLocation.lat, userLocation.lng], 12);

                        // Add user marker
                        addUserMarker();
                    },
                    error => {
                        console.warn('Geolocation error:', error.message);
                        // Geolocation failed, use default location
                        initializeMap(defaultLocation, initialZoom);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                console.warn('Geolocation is not supported by this browser');
                // Geolocation not supported, use default location
                initializeMap(defaultLocation, initialZoom);
            }

            function initializeMap(center: [number, number], zoom: number) {
                // Initialize Leaflet map
                map = window.L.map('myMap').setView(center, zoom);

                window.L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);

                // Close popup when clicking on the map
                map.on('click', _e => {
                    if (currentPopup) {
                        currentPopup.remove();
                    }
                });

                if (onMapLoad) onMapLoad()
                positionInterval = setInterval(onMapLoad, 60000)
            }

            function addUserMarker() {
                if (userLocation) {
                    // Create custom green icon for user location
                    var userIcon = window.L.divIcon({
                        html: '<div style="background-color: green; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                        className: 'user-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    // Add a marker for user's location
                    userPin = window.L.marker([userLocation.lat, userLocation.lng], {
                        icon: userIcon,
                        title: 'Your Location'
                    });

                    // Add click handler to show nearby vehicles
                    userPin.on('click', showNearbyVehicles);

                    userPin.addTo(map);
                }
            }
        }
        else {
            window.addEventListener('DOMContentLoaded', GetMap)
        }
    }


    function showVehicleInfo(_e: L.LeafletMouseEvent, pin: VehicleMarker) {
        //Make sure the marker has metadata to display.
        var data = pin.metadata
        if (data) {
            var isSmallScreen = window.matchMedia('(max-width: 915px)').matches
            if (isSmallScreen) {

            }

            data.LineName = data.PublishedLineName
            if (data.LineName) {
                if (data.LineName.includes('\\\\')) data.LineName = data.LineName.split('\\\\').join('/')
                if (data.LineName.includes(' / ')) data.LineName = data.LineName.split(' / ').join('/')
                if (data.LineName.includes('/')) data.LineName = data.LineName.split('/').join(' - ')
                if (data.LineName.includes('  ')) data.LineName = data.LineName.split('  ').join(' ')
            }

            var titleHtml = `${data.agency}<br>${data.LineRef}: ${data.LineName || ''}`
            var descriptionHtml = [
                `Direction: ${data.DirectionRef ? data.DirectionRef : 'Unknown Direction'}`,
                `Origin: ${data.OriginName ? data.OriginName : 'No Origin or Unknown'}`,
                `Destination: ${data.DestinationName ? data.DestinationName : 'No Destination or Unknown'}`,
                `Congestion: ${data.InCongestion ? 'Congested' : 'Not Congested or Unknown'}`,
                `Occupancy: ${data.Occupancy ? data.Occupancy : 'Unknown'}`,
                `Vehicle ID: ${data.VehicleRef ? data.VehicleRef : 'Unknown'}`
            ].join('<br>')

            function buildPopupContent(stopsHtml: string) {
                return `<div class="infobox">
                    <span class="title">${titleHtml}</span><span>${descriptionHtml}</span><ol class="stops">${stopsHtml}</ol>
                </div>`
            }

            if (currentPopup) {
                currentPopup.remove()
            }
            currentPopup = window.L.popup()
                .setLatLng(pin.getLatLng())
                .setContent(buildPopupContent('<li>Loading stops...</li>'))
                .openOn(map)

            window.makeRequest('patterns', [['operator_id', data.aId], ['line_id', data.LineRef]], res => {
                var typedRes = res as { journeyPatterns?: JourneyPattern[] }
                var journeyPatterns = typedRes.journeyPatterns
                var pattern: JourneyPattern | null = null
                if (journeyPatterns) {
                    var filtered = journeyPatterns.filter(p => p.DirectionRef === data.DirectionRef)
                    if (filtered.length > 0) pattern = filtered[0]
                }

                var TimingPointInJourneyPattern: TimingPoint[] = []
                if (pattern && pattern.PointsInSequence && pattern.PointsInSequence.TimingPointInJourneyPattern) {
                    TimingPointInJourneyPattern = [...pattern.PointsInSequence.TimingPointInJourneyPattern]
                }

                var stops: StopCall[] = []
                if (data.MonitoredCall) stops.push(data.MonitoredCall)
                if (data.OnwardCalls && data.OnwardCalls.OnwardCall && data.OnwardCalls.OnwardCall.length > 0) {
                    data.OnwardCalls.OnwardCall.forEach(stop => {
                        stops.push(stop)
                    })
                }

                stops.forEach(stop => {
                    var items = TimingPointInJourneyPattern.filter(t => t.Name === stop.StopPointName)
                    if (items && items.length > 0) {
                        if (items.length > 1) {
                            items.forEach(i => {
                                TimingPointInJourneyPattern.splice(TimingPointInJourneyPattern.indexOf(i), 1)
                            })
                        } else {
                            TimingPointInJourneyPattern.splice(TimingPointInJourneyPattern.indexOf(items[0]), 1)
                        }
                    }
                })

                var stopsHtml = ''
                stops.forEach(stop => {
                    var eDate = new Date(stop.ExpectedArrivalTime)
                    var aDate = new Date(stop.AimedArrivalTime)
                    var eTime = eDate.getTime()
                    var aTime = aDate.getTime()

                    var stopTime = `${eDate.getHours().toString().padStart(2, '0')}:${eDate.getMinutes().toString().padStart(2, '0')}`

                    var isLate = eTime > aTime
                    var isEarly = eTime < aTime
                    var isOnTime = eTime === aTime

                    var earlyLateText = ''
                    if (isLate) earlyLateText = `${Math.ceil((eTime-aTime)/60000)} Minutes Late`
                    if (isEarly) earlyLateText = `${Math.ceil((aTime-eTime)/60000)} Minutes Early`
                    if (isOnTime) earlyLateText = 'On Time'

                    var color = isLate ? 'red' : (isEarly ? 'green' : (isOnTime ? 'blue' : 'black'))

                    stopsHtml += `<li class="stop" style="color: ${color}">${stop.StopPointName} (${stop.StopPointRef}): ${stopTime} (${earlyLateText})</li>`
                })

                if (!stopsHtml) stopsHtml = '<li>No stop information available</li>'

                if (currentPopup) currentPopup.setContent(buildPopupContent(stopsHtml))
            })
        }
    }

    function showRoutePath(_aId: unknown, _rId: unknown) {
        // TODO: Implement route path display with Leaflet
        // This would require using a routing service or drawing polylines
        console.log('Route path display not yet implemented with Leaflet');
    }
    window.showRoutePath = showRoutePath

    function findUsingValueofKey(arr: Record<string, unknown>[], key: string, val: unknown) {
        var res = arr.filter((item: Record<string, unknown>) => item[key] === val)
        return res
    }
    window.findUsingValueofKey = findUsingValueofKey
</script>
