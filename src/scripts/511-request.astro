<script>
    // Track delay for rate limiting
    let requestDelay = 0 // milliseconds

    // Helper function to wait/delay
    const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms))

    async function makeRequest(moduleName: string, params: string[][] = [], callback: (data: unknown) => void = () => {}) {
        // Apply current delay if any
        if (requestDelay > 0) {
            await delay(requestDelay)
        }

        // Prepare params for API route
        const paramsString = Array.isArray(params) && params.length > 0
            ? JSON.stringify(params)
            : ''

        // Build URL for our API route
        const url = `/api/511?module=${encodeURIComponent(moduleName)}${paramsString ? `&params=${encodeURIComponent(paramsString)}` : ''}`

        try {
            const response = await fetch(url)
            // Handle 429 Rate Limit with exponential backoff
            if (response.status === 429) {
                if (requestDelay === 0) {
                    requestDelay = 1000 // Start with 1 second
                } else {
                    requestDelay = Math.min(requestDelay * 2, 32000) // Double up to max 32 seconds
                }
                console.log(`[Client] Rate limited (429). Increasing delay to ${requestDelay}ms and retrying...`)
                return await makeRequest(moduleName, params, callback)
            }

            if (!response.ok) {
                const data = await response.json().catch(() => ({}))
                console.error('511 API Error Response:', data)
                throw new Error(`HTTP error! status: ${response.status}, message: ${data.error || 'Unknown error'}`)
            }

            const data = await response.json()
            if (data.error) {
                console.error('511 API returned error:', data.error)
                throw new Error(data.error)
            }

            // Success - reset delay gradually
            if (requestDelay > 0) {
                requestDelay = Math.max(requestDelay / 2, 0)
            }

            callback(data)
        } catch (err) {
            console.error('511 API Error:', err)
        }
    }
    window.makeRequest = makeRequest
</script>
