<script>
    var settingEles = document.querySelectorAll('setting-option')
    // var selectEles = document.querySelectorAll('setting-option select')

    window.addEventListener('DOMContentLoaded', _e => {
        settingEles = document.querySelectorAll('setting-option')
        // selectEles = document.querySelectorAll('setting-option select')

        applySettings()
        if (location.pathname.startsWith('/settings')) {
            settingEles.forEach(s => {
                const sel = s.querySelector('select')
                if (sel) {
                    sel.onchange = e => {
                        setSetting(s.getAttribute('module-name')!, (e.target as HTMLSelectElement).value)
                    }
                }
            })
        }
    })

    var setTheme = (t: string) => {
        document.documentElement.setAttribute('data-theme', (t || 'system'))
    }
    var settingsKey = 'settings'

    type Setting = { name: string; content?: any }
    type SettingFunctions = { [key: string]: (value: any) => void }

    var settingFunctions: SettingFunctions = {
        theme: (theme: string) => {
            setTheme(theme)
        }
    }
    applySettings()

    function getSettings(): Setting[] {
        var raw = localStorage.getItem(settingsKey) || '[]'
        return JSON.parse(raw) as Setting[]
    }

    function applySettings() {
        var settings = getSettings()
        settings.forEach(s => {
            settingFunctions[s.name](s.content)
        })

        if (location.pathname.startsWith('/settings') && settings.length > 0) {
            settingEles.forEach(s => {
                var setting = settings.filter(filterCheck)[0].content
                const sel = s.querySelector('select')
                if (sel) {
                    sel.value = setting
                }
            })
        }
    }

    function filterCheck(setting: Setting) {
        return setting.name === 'theme'
    }

    function setSetting(name: string, value: string, type?: string, key?: string) {
        var settings = getSettings()
        console.log(settings)

        var item: Setting | undefined
        if (settings.length > 0) {
            item = settings.filter(filterCheck)[0]
        }

        var index = item ? settings.indexOf(item) : -1

        if (index < 0 || settings.length < 1) {
            var settingsLength = settings.length
            settings.push({name: name})
            index = settingsLength
        }

        var setting = settings[index]
        var content: any = setting.content
        if (!content) {
            switch(type) {
                case 'object':
                    content = {}
                    break
                case 'list':
                    content = []
                    break
                default:
                    content = ''
                    break
            }
        }

        switch(type) {
            case 'object':
                if (key !== undefined) content[key] = value
                break
            case 'list':
                content.push(value)
                break
            default:
                content = value
                break
        }

        setting.content = content
        settings[index] = setting
        localStorage.setItem(settingsKey, JSON.stringify(settings))

        settingFunctions[setting.name](setting.content)
    }
</script>
